/**
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to
 * deal in the Software without restriction, including without limitation the
 * rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
 * sell copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
 * IN THE SOFTWARE.
 */

/**
 * Implementing Drag and Drop functionality in AngularJS is easier than ever.
 * Demo: http://codef0rmer.github.com/angular-dragdrop/
 * 
 * @version 1.0.11
 *
 * (c) 2013 Amit Gharat a.k.a codef0rmer <amit.2006.it@gmail.com> - amitgharat.wordpress.com
 */
!function(e,t,a,n){"use strict";var l=t.module("ngDragDrop",[]).service("ngDragDropService",["$timeout","$parse","$q",function(r,i,o){this.draggableScope=null,this.droppableScope=null,t.element(document).find("head").prepend('<style type="text/css">@charset "UTF-8";.angular-dragdrop-hide{display: none !important;}</style>'),this.callEventCallback=function(e,t,n,l){function r(t){var n=-1!==t.indexOf("(")?t.indexOf("("):t.length,l=-1!==t.lastIndexOf(")")?t.lastIndexOf(")"):t.length,r=t.substring(n+1,l),o=-1!==t.indexOf(".")?t.substr(0,t.indexOf(".")):null;return o=e[o]&&"function"==typeof e[o].constructor?o:null,{callback:t.substring(o&&o.length+1||0,n),args:a.map(r&&r.split(",")||[],function(t){return[i(t)(e)]}),constructor:o}}if(t){var o=r(t),d=o.callback,s=o.constructor,p=[n,l].concat(o.args);return(e[d]||e[s][d]).apply(e,p)}},this.invokeDrop=function(e,a,i,d){var s,p,c="",u="",g={},b={},f=null,h={},v={},y=null,m=this.droppableScope,D=this.draggableScope,x=null,q=[];c=e.ngattr("ng-model"),u=a.ngattr("ng-model"),s=D.$eval(c),p=m.$eval(u),y=a.find("[jqyoui-draggable]:last,[data-jqyoui-draggable]:last"),b=m.$eval(a.attr("jqyoui-droppable")||a.attr("data-jqyoui-droppable"))||[],g=D.$eval(e.attr("jqyoui-draggable")||e.attr("data-jqyoui-draggable"))||[],g.index=this.fixIndex(D,g,s),b.index=this.fixIndex(m,b,p),f=t.isArray(s)?g.index:null,h=t.isArray(s)?s[f]:s,g.deepCopy&&(h=t.copy(h)),v=t.isArray(p)&&b&&b.index!==n?p[b.index]:t.isArray(p)?{}:p,b.deepCopy&&(v=t.copy(v)),g.beforeDrop&&q.push(this.callEventCallback(D,g.beforeDrop,i,d)),o.all(q).then(t.bind(this,function(){g.animate===!0?(x=e.clone(),x.css({position:"absolute"}).css(e.offset()),t.element(document).find("body").append(x),e.addClass("angular-dragdrop-hide"),this.move(x,y.length>0?y:a,null,"fast",b,function(){x.remove()}),this.move(y.length>0&&!b.multiple?y:[],e.parent("[jqyoui-droppable],[data-jqyoui-droppable]"),l.startXY,"fast",b,t.bind(this,function(){r(t.bind(this,function(){e.css({position:"relative",left:"",top:""}).removeClass("angular-dragdrop-hide"),y.css({position:"relative",left:"",top:"",display:"none"===y.css("display")?"":y.css("display")}),this.mutateDraggable(D,b,g,c,u,v,e),this.mutateDroppable(m,b,g,u,h,f),this.callEventCallback(m,b.onDrop,i,d)}))}))):r(t.bind(this,function(){this.mutateDraggable(D,b,g,c,u,v,e),this.mutateDroppable(m,b,g,u,h,f),this.callEventCallback(m,b.onDrop,i,d)}))}),function(){d.draggable.css({left:"",top:""})})},this.move=function(t,a,l,r,i,o){if(0===t.length)return o&&e.setTimeout(function(){o()},300),!1;var d=t.css("z-index"),s=t[i.containment||"offset"](),p=a.css("display"),c=a.hasClass("ng-hide");null===l&&a.length>0&&((a.attr("jqyoui-draggable")||a.attr("data-jqyoui-draggable"))!==n&&a.ngattr("ng-model")!==n&&a.is(":visible")&&i&&i.multiple?(l=a[i.containment||"offset"](),i.stack===!1?l.left+=a.outerWidth(!0):l.top+=a.outerHeight(!0)):(c&&a.removeClass("ng-hide"),l=a.css({visibility:"hidden",display:"block"})[i.containment||"offset"](),a.css({visibility:"",display:p}))),t.css({position:"absolute","z-index":9999}).css(s).animate(l,r,function(){c&&a.addClass("ng-hide"),t.css("z-index",d),o&&o()})},this.mutateDroppable=function(e,a,n,l,r,o){var d=e.$eval(l);e.dndDragItem=r,t.isArray(d)?(a&&a.index>=0?d[a.index]=r:d.push(r),n&&n.placeholder===!0&&(d[d.length-1].jqyoui_pos=o)):(i(l+" = dndDragItem")(e),n&&n.placeholder===!0&&(d.jqyoui_pos=o)),delete e.dndDragItem},this.mutateDraggable=function(e,a,l,r,o,d,s){var p=t.equals(d,{})||!d,c=e.$eval(r);e.dndDropItem=d,l&&l.placeholder?"keep"!=l.placeholder&&(t.isArray(c)&&l.index!==n?c[l.index]=d:i(r+" = dndDropItem")(e)):(t.isArray(c)?p?l&&l.placeholder!==!0&&"keep"!==l.placeholder&&c.splice(l.index,1):c[l.index]=d:i(r+" = dndDropItem")(e),delete e.dndDropItem),s.css({"z-index":"",left:"",top:""})},this.fixIndex=function(e,a,l){if(a.applyFilter&&t.isArray(l)&&l.length>0){var r=e[a.applyFilter](),i=r[a.index],o=n;return l.forEach(function(e,a){t.equals(e,i)&&(o=a)}),o}return a.index}}]).directive("jqyouiDraggable",["ngDragDropService",function(e){return{require:"?jqyouiDroppable",restrict:"A",link:function(a,n,r){var i,o,d,s,p=function(p){p?(i=a.$eval(n.attr("jqyoui-draggable")||n.attr("data-jqyoui-draggable"))||{},o=a.$eval(r.jqyouiOptions)||{},n.draggable({disabled:!1}).draggable(o).draggable({start:function(n,r){e.draggableScope=a,d=t.element(o.helper?r.helper:this).css("z-index"),t.element(o.helper?r.helper:this).css("z-index",9999),l.startXY=t.element(this)[i.containment||"offset"](),e.callEventCallback(a,i.onStart,n,r)},stop:function(n,l){t.element(o.helper?l.helper:this).css("z-index",d),e.callEventCallback(a,i.onStop,n,l)},drag:function(t,n){e.callEventCallback(a,i.onDrag,t,n)}})):n.draggable({disabled:!0}),s&&t.isDefined(p)&&(t.equals(r.drag,"true")||t.equals(r.drag,"false"))&&(s(),s=null)};s=a.$watch(function(){return a.$eval(r.drag)},p),p(),n.on("$destroy",function(){n.draggable({disabled:!0}).draggable("destroy")})}}}]).directive("jqyouiDroppable",["ngDragDropService","$q",function(e,a){return{restrict:"A",priority:1,link:function(n,l,r){var i,o,d=function(d){d?(i=n.$eval(t.element(l).attr("jqyoui-droppable")||t.element(l).attr("data-jqyoui-droppable"))||{},l.droppable({disabled:!1}).droppable(n.$eval(r.jqyouiOptions)||{}).droppable({over:function(t,a){e.callEventCallback(n,i.onOver,t,a)},out:function(t,a){e.callEventCallback(n,i.onOut,t,a)},drop:function(l,o){var d=null;d=i.beforeDrop?e.callEventCallback(n,i.beforeDrop,l,o):function(){var e=a.defer();return e.resolve(),e.promise}(),d.then(t.bind(this,function(){t.element(o.draggable).ngattr("ng-model")&&r.ngModel?(e.droppableScope=n,e.invokeDrop(t.element(o.draggable),t.element(this),l,o)):e.callEventCallback(n,i.onDrop,l,o)}),function(){o.draggable.css({left:"",top:""})})}})):l.droppable({disabled:!0}),o&&t.isDefined(d)&&(t.equals(r.drop,"true")||t.equals(r.drop,"false"))&&(o(),o=null)};o=n.$watch(function(){return n.$eval(r.drop)},d),d(),l.on("$destroy",function(){l.droppable({disabled:!0}).droppable("destroy")})}}}]);t.element.prototype.ngattr=function(e){var a=t.element(this).get(0);return a.getAttribute(e)||a.getAttribute("data-"+e)}}(window,window.angular,window.jQuery);
